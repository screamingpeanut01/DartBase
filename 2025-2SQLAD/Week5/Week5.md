# Week5

# SQL_ADVANCED 5ì£¼ì°¨ ì •ê·œ ê³¼ì œ

## Week 5 : ê³„ì¸µí˜• ì§ˆì˜ & ì…€í”„ ì¡°ì¸

ðŸ“Œ**SQL_ADVANCED ì •ê·œê³¼ì œ**ëŠ” ë§¤ì£¼ ì •í•´ì§„ ì£¼ì œì— ë”°ë¼ **MySQL ê³µì‹ ë¬¸ì„œ ë˜ëŠ” í•œê¸€ ë¸”ë¡œê·¸ ìžë£Œë¥¼ ì°¸ê³ í•´ ê°œë…ì„ ì •ë¦¬í•œ í›„, í”„ë¡œê·¸ëž˜ë¨¸ìŠ¤ SQL ë¬¸ì œ 3ë¬¸ì œ**ì™€ **ì¶”ê°€ í™•ì¸ë¬¸ì œ**ë¥¼ ì§ì ‘ í’€ì–´ë³´ë©° í•™ìŠµí•˜ëŠ” ê³¼ì œìž…ë‹ˆë‹¤.

ì´ë²ˆ ì£¼ëŠ” ì•„ëž˜ì˜ **SQL_ADVANCED_5th_TIL**ì— ë‚˜ì—´ëœ ì£¼ì œë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ê°œë…ì„ í•™ìŠµí•˜ê³ , ì£¼ì°¨ë³„ **í•™ìŠµ ëª©í‘œ**ì— ë§žê²Œ ì •ë¦¬í•´ì£¼ì„¸ìš”. ì •ë¦¬í•œ ë‚´ìš©ì€ GitHubì— ì—…ë¡œë“œí•œ í›„, **ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì˜ 'SQL' ì‹œíŠ¸ì— ë§í¬ë¥¼ ì œì¶œ**í•´ì£¼ì„¸ìš”.

**(ìˆ˜í–‰ ì¸ì¦ìƒ·ì€ í•„ìˆ˜ìž…ë‹ˆë‹¤.)**

> í”„ë¡œê·¸ëž˜ë¨¸ìŠ¤ ë¬¸ì œë¥¼ í’€ê³  'ì •ë‹µìž…ë‹ˆë‹¤' ë¬¸êµ¬ë¥¼ ìº¡ì³í•´ì„œ ì˜¬ë ¤ì£¼ì‹œë©´ ë©ë‹ˆë‹¤.
> 

## SQL_ADVANCED_5th

### 15.2.20 WITH (Common Table Expressions)

- **ìž¬ê·€ CTEë¥¼ í†µí•œ ê³„ì¸µí˜• êµ¬ì¡° íƒìƒ‰ ë°©ë²•ì„ ì¤‘ì‹¬ìœ¼ë¡œ í•™ìŠµí•´ì£¼ì„¸ìš”.**

> Self Joinì€ ë”°ë¡œ MySQL ê³µì‹ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë¸”ë¡œê·¸ë‚˜ ìœ íŠœë¸Œ ì˜ìƒì„ ì°¸ê³ í•˜ì—¬ ìŠ¤ìŠ¤ë¡œ í•™ìŠµí•˜ê³ , ë„£ì–´ì£¼ì„¸ìš”.
> 

## ðŸ ê°•ì˜ ìˆ˜ê°• (Study Schedule)

| ì£¼ì°¨ | ê³µë¶€ ë²”ìœ„ | ì™„ë£Œ ì—¬ë¶€ |
| --- | --- | --- |
| 1ì£¼ì°¨ | ì„œë¸Œì¿¼ë¦¬ & CTE | âœ… |
| 2ì£¼ì°¨ | ì§‘í•© ì—°ì‚°ìž & ê·¸ë£¹ í•¨ìˆ˜ | âœ… |
| 3ì£¼ì°¨ | ìœˆë„ìš° í•¨ìˆ˜ | âœ… |
| 4ì£¼ì°¨ | Top N ì¿¼ë¦¬ | âœ… |
| 5ì£¼ì°¨ | ê³„ì¸µí˜• ì§ˆì˜ì™€ ì…€í”„ ì¡°ì¸ | âœ… |
| 6ì£¼ì°¨ | PIVOT / UNPIVOT | ðŸ½ï¸ |
| 7ì£¼ì°¨ | ì •ê·œ í‘œí˜„ì‹ | ðŸ½ï¸ |

### ê³µì‹ ë¬¸ì„œ í™œìš© íŒ

> MySQL ê³µì‹ ë¬¸ì„œëŠ” ì˜ì–´ë¡œ ì œê³µë˜ì§€ë§Œ, í¬ë¡¬ ë¸Œë¼ìš°ì €ì—ì„œ ê³µì‹ ë¬¸ì„œë¥¼ ì—´ê³  ì´ íŽ˜ì´ì§€ ë²ˆì—­í•˜ê¸°ì—ì„œ í•œêµ­ì–´ë¥¼ ì„ íƒí•˜ë©´ ë²ˆì—­ëœ ë²„ì „ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. ë‹¤ë§Œ, ë²ˆì—­ë³¸ì€ ë¬¸ë§¥ì´ ì–´ìƒ‰í•œ ë¶€ë¶„ì´ ì¢…ì¢… ìžˆìœ¼ë‹ˆ ì˜ì–´ ì›ë¬¸ê³¼ í•œêµ­ì–´ ë²ˆì—­ë³¸ì„ ì™”ë‹¤ ê°”ë‹¤ í•˜ë©° í™•ì¸í•˜ê±°ë‚˜, êµìœ¡íŒ€ìž¥ì˜ ì •ë¦¬ ì˜ˆì‹œë¥¼ ì°¸ê³ í•˜ì…”ë„ ê´œì°®ìŠµë‹ˆë‹¤.
> 

# 1ï¸âƒ£ í•™ìŠµ ë‚´ìš©

> ì•„ëž˜ì˜ ë§í¬ë¥¼ í†µí•´ MySQL ê³µì‹ë¬¸ì„œë¡œ ì´ë™í•˜ì‹¤ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
> 
> - 15.2.20 WITH (Common Table Expressions) : MySQL ê³µì‹ë¬¸ì„œ
> 
> [https://dev.mysql.com/doc/refman/8.0/en/with.html](https://dev.mysql.com/doc/refman/8.0/en/with.html)
> 
> (í•œêµ­ì–´ ë²„ì „) [https://dart-b-official.github.io/posts/mysql-RecursiveWith/](https://dart-b-official.github.io/posts/mysql-RecursiveWith/)
> 

<br>

---

# 2ï¸âƒ£ í•™ìŠµ ë‚´ìš© ì •ë¦¬í•˜ê¸°

## ê³„ì¸µí˜• ì§ˆì˜ (WITH RECURSIVE)

`WITH RECURSIVE`ëŠ” ìžê¸° ìžì‹ ì„ ì°¸ì¡°í•  ìˆ˜ ìžˆëŠ” CTE(Common Table Expression)ë¥¼ ì •ì˜í•˜ëŠ” êµ¬ë¬¸

ì´ëŠ” ì¡°ì§ë„, ë¶€í’ˆ íŠ¸ë¦¬, ë©”ë‰´ êµ¬ì¡°, ì¹œêµ¬ ê´€ê³„ ë“± ê¹Šì´ë¥¼ ë¯¸ë¦¬ ì•Œ ìˆ˜ ì—†ëŠ” ê³„ì¸µ êµ¬ì¡°ë‚˜ ê·¸ëž˜í”„ë¥¼ ìˆœíšŒ(traverse)í•˜ëŠ” ë° í•„ìˆ˜ì 

### `WITH RECURSIVE`ì˜ êµ¬ì¡°

`WITH RECURSIVE` CTEëŠ” ë‘ ë¶€ë¶„ìœ¼ë¡œ êµ¬ì„±ë˜ë©°, `UNION ALL` (ë˜ëŠ” `UNION`)ë¡œ ê²°í•©

1. **ì•µì»¤ ë©¤ë²„ (Anchor Member):**
    - ìž¬ê·€ì˜ ì‹œìž‘ì (ê¸°ë³¸ ì¼€ì´ìŠ¤)ì´ ë˜ëŠ” ì¿¼ë¦¬
    - ìžê¸° ìžì‹ (CTE)ì„ ì°¸ì¡°í•˜ì§€ ì•ŠìŒ
    - ì˜ˆ: ì¡°ì§ë„ì—ì„œ ìµœìƒìœ„ CEOë¥¼ ì°¾ëŠ” ì¿¼ë¦¬
2. **ìž¬ê·€ ë©¤ë²„ (Recursive Member):**
    - CTE ìžê¸° ìžì‹ ì„ ì°¸ì¡°í•˜ì—¬ ì´ì „ ë‹¨ê³„ì˜ ê²°ê³¼ì™€ ì¡°ì¸í•˜ëŠ” ì¿¼ë¦¬
    - ì´ ë¶€ë¶„ì´ ë°˜ë³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ë©° ê³„ì¸µì„ í•œ ë‹¨ê³„ì”© í™•ìž¥
    - ì˜ˆ: ì´ì „ ë‹¨ê³„ì—ì„œ ì°¾ì€ ê´€ë¦¬ìž(manager)ì—ê²Œ ë³´ê³ í•˜ëŠ” ì§ì›ì„ ì°¾ëŠ” ì¿¼ë¦¬

ìž¬ê·€ëŠ” ìž¬ê·€ ë©¤ë²„ê°€ ë” ì´ìƒ ìƒˆë¡œìš´ í–‰ì„ ë°˜í™˜í•˜ì§€ ì•Šì„ ë•Œ ì¤‘ì§€

## ì…€í”„ ì¡°ì¸ (Self-Join)ê³¼ì˜ ë¹„êµ

`WITH RECURSIVE`ê°€ ë„ìž…ë˜ê¸° ì „(MySQL 8.0 ì´ì „), ê³„ì¸µ êµ¬ì¡°ë¥¼ ì¿¼ë¦¬í•˜ëŠ” ì£¼ëœ ë°©ë²• ì¤‘ í•˜ë‚˜ëŠ” ì…€í”„ ì¡°ì¸

### ì…€í”„ ì¡°ì¸ (Self-Join) ë°©ì‹

- **ì •ì˜:** í•˜ë‚˜ì˜ í…Œì´ë¸”ì´ ìžê¸° ìžì‹ ì„ ì¡°ì¸í•˜ëŠ” ë°©ì‹ (ì˜ˆ: `FROM employees e1 JOIN employees e2 ON e1.manager_id = e2.employee_id`)
- **ìš©ë„:** ì£¼ë¡œ *ê³ ì •ëœ* ê¹Šì´ì˜ ê´€ê³„ë¥¼ ì°¾ëŠ” ë° ì‚¬ìš©
    - ì˜ˆ: íŠ¹ì • ì§ì›ì˜ ì§ì† ìƒì‚¬ ì°¾ê¸° (1ë‹¨ê³„)
    - ì˜ˆ: íŠ¹ì • ì§ì›ì˜ 'ìƒì‚¬ì˜ ìƒì‚¬' ì°¾ê¸° (2ë‹¨ê³„, í…Œì´ë¸”ì„ 3ë²ˆ ì¡°ì¸)
- **í•œê³„ì :**
    - **ìž„ì˜ì˜ ê¹Šì´ ì²˜ë¦¬ ë¶ˆê°€:** ê³„ì¸µì˜ ê¹Šì´ë¥¼ ë¯¸ë¦¬ ì•Œ ìˆ˜ ì—†ëŠ” ê²½ìš°(ì˜ˆ: "íŠ¹ì • ê´€ë¦¬ìž í•˜ìœ„ì˜ ëª¨ë“  ì§ì› ì°¾ê¸°"), ì…€í”„ ì¡°ì¸ë§Œìœ¼ë¡œëŠ” í•œê³„ê°€ ëª…í™•
    - **ë³µìž¡ì„± ë° ì„±ëŠ¥:** ê³„ì¸µì˜ ê¹Šì´ë§Œí¼ í…Œì´ë¸”ì„ ê³„ì† ì¡°ì¸í•´ì•¼ í•˜ë¯€ë¡œ ì¿¼ë¦¬ê°€ ë§¤ìš° ë³µìž¡í•´ì§€ê³ , ê¹Šì´ê°€ ê¹Šì–´ì§ˆìˆ˜ë¡ ì„±ëŠ¥ì´ ê¸‰ê²©ížˆ ì €í•˜

### `WITH RECURSIVE`ì™€ì˜ í•µì‹¬ ë¹„êµ

| íŠ¹ì§• | ì…€í”„ ì¡°ì¸ (Self-Join) | `WITH RECURSIVE` |
| --- | --- | --- |
| **ì£¼ìš” ìš©ë„** | ê³ ì •ëœ(ì–•ì€) ê¹Šì´ì˜ ê´€ê³„ | ìž„ì˜ì˜(ê¹Šì€) ê³„ì¸µ êµ¬ì¡° ìˆœíšŒ |
| **ìœ ì—°ì„±** | ë‚®ìŒ (ê¹Šì´ê°€ ì •í•´ì ¸ ìžˆì–´ì•¼ í•¨) | ë†’ìŒ (ê³„ì¸µì˜ ê¹Šì´ì™€ ë¬´ê´€í•˜ê²Œ ìž‘ë™) |
| **ì¿¼ë¦¬ ë³µìž¡ë„** | ê¹Šì–´ì§ˆìˆ˜ë¡ ë§¤ìš° ë³µìž¡í•´ì§ | ë‹¨ì¼ ì¿¼ë¦¬ë¡œ ì¼ê´€ì„± ìžˆê²Œ ìž‘ì„± ê°€ëŠ¥ |
| **ì„±ëŠ¥** | ê¹Šì€ ê³„ì¸µì—ì„œ ë¹„íš¨ìœ¨ì  | ê³„ì¸µ êµ¬ì¡° ì²˜ë¦¬ì— ìµœì í™”ë¨ |
| **MySQL ì§€ì›** | ëª¨ë“  ë²„ì „ | MySQL 8.0 ì´ìƒ |

---

# 3ï¸âƒ£ ì‹¤ìŠµ ë¬¸ì œ

## ë¬¸ì œ

- [https://leetcode.com/problems/employees-earning-more-than-their-managers/](https://leetcode.com/problems/employees-earning-more-than-their-managers/)

> LeetCode 181. Employees  Earning More Than Their Managers
> 
> 
> í•™ìŠµ í¬ì¸íŠ¸ : ë™ì¼ í…Œì´ë¸”ì„ ë‘ ë²ˆ ì¡°ì¸ (ì™œ ë™ì¼ í…Œì´ë¸”ì„ JOIN í•´ì•¼í•˜ëŠ” ë¬¸ì œì¼ê¹Œ)
> 
- [https://leetcode.com/problems/tree-node/description/](https://leetcode.com/problems/tree-node/description/)

> LeetCode 608. Tree Node
> 
> 
> í•™ìŠµ í¬ì¸íŠ¸ : id, parent_id ê¸°ë°˜ì˜ íŠ¸ë¦¬ êµ¬ì¡°ì—ì„œ **ë¶€ëª¨ ~ ìžì‹ ê´€ê³„ ìž¬ê·€ íƒìƒ‰**
> 
> Hint : (ë¬¸ì œ í•´ì„)
> 
> - ì–´ë–¤ ë…¸ë“œê°€ Root Node ì´ë ¤ë©´, ë¶€ëª¨ë…¸ë“œê°€ ì¡´ìž¬í•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤.
> - ì–´ë–¤ ë…¸ë“œê°€ Inner Node ì´ë ¤ë©´, ë‚˜ë¥¼ ë¶€ëª¨ë¡œ ê°€ì§€ëŠ” ë…¸ë“œê°€ í•˜ë‚˜ ì´ìƒ ì¡´ìž¬í•˜ì—¬ì•¼ í•œë‹¤.
>     - ê·¸ ì™¸ë„¤ëŠ” ëª¨ë‘ Leaf Node ì´ë‹¤. --> (CASE ë¬¸ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ì¶”ì²œë“œë¦½ë‹ˆë‹¤.)
- [https://school.programmers.co.kr/learn/courses/30/lessons/144856](https://school.programmers.co.kr/learn/courses/30/lessons/144856)

> í”„ë¡œê·¸ëž˜ë¨¸ìŠ¤ : ì €ìž ë³„ ì¹´í…Œê³ ë¦¬ ë³„ ë§¤ì¶œì•¡ ì§‘ê³„í•˜ê¸°
> 
> 
> í•™ìŠµ í¬ì¸íŠ¸ : ì¹´í…Œê³ ë¦¬ì™€ ì„œë¸Œì¹´í…Œê³ ë¦¬ ê³„ì¸µ êµ¬ì¡°ë¥¼ ë¶„ì„í•˜ëŠ” ë¡œì§, SELF JOIN / CTEë¥¼ ë‹¤ í™œìš©í•  ìˆ˜ ìžˆë‹¤.
> 
> - ìœ„ì— 2ê°€ì§€ì˜ ë¬¸ì œë¥¼ í’€ì–´ë³´ê³  ë‚œ ì´í›„, ë” íŽ¸ë¦¬í•œ ë°©ë²•ìœ¼ë¡œ ë¬¸ì œë¥¼ í’€ì–´ë³´ì„¸ìš”.

---

## ë¬¸ì œ ì¸ì¦ëž€

![image.png](image.png)

![image.png](image%201.png)

![image.png](image%202.png)

---

# í™•ì¸ë¬¸ì œ

## ë¬¸ì œ 1

> ðŸ§šìœ¤ì„œëŠ” ì–´ë–¤ ê¸°ì—…ì˜ ì¡°ì§ êµ¬ì¡°ë¥¼ ë¶„ì„í•˜ëŠ” SQL ì¿¼ë¦¬ë¥¼ ìž‘ì„±í•˜ê³  ìžˆìŠµë‹ˆë‹¤. ê° ì§ì›ì€ ìƒìœ„ ê´€ë¦¬ìž ID(manager_id)ë¥¼ ê°€ì§€ë©°, ì¡°ì§ë„ëŠ” ê°™ì€ Employees í…Œì´ë¸” ë‚´ì—ì„œ ê³„ì¸µì ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤. ìœ¤ì„œëŠ” ìµœìƒìœ„ ê´€ë¦¬ìžë¶€í„° ê° ì‚¬ì›ê¹Œì§€ì˜ ê³„ì¸µ ê¹Šì´(depth)ë¥¼ ê³„ì‚°í•˜ê³ ìž ë‹¤ìŒê³¼ ê°™ì€ SELF JOIN ê¸°ë°˜ ì¿¼ë¦¬ë¥¼ ì‹œë„í–ˆìŠµë‹ˆë‹¤.
> 

```sql
SELECT e1.id, e1.name, e2.name AS manager_name
FROM Employees e1
LEFT JOIN Employees e2 ON e1.manager_id = e2.id;

```

> ì¿¼ë¦¬ë¥¼ ìž˜ ìž‘ì„±í–ˆë‹¤ê³  ìƒê°ì„ í–ˆì§€ë§Œ, ë§‰ìƒ ì‹¤í–‰ì„ í•´ë³´ë‹ˆ 1ë‹¨ê³„ ë§¤ë‹ˆì €ê¹Œì§€ë§Œ ì¶”ì í•  ìˆ˜ ìžˆì–´ ê³„ì¸µ êµ¬ì¡°ì˜ ì „ì²´ë¥¼  í‘œí˜„í•˜ëŠ”ë° í•œê³„ê°€ ì¡´ìž¬í–ˆìŠµë‹ˆë‹¤. ì´ì— ì—¬ëŸ¬ë¶„ì—ê²Œ ë‹¤ìŒê³¼ ê°™ì€ ë¯¸ì…˜ì„ ìš”ì²­í•©ë‹ˆë‹¤. WITH RECURSIVEë¥¼ í™œìš©í•˜ì—¬  ìµœìƒìœ„ ê´€ë¦¬ìžë¶€í„° ì‹œìž‘í•´ ê° ì§ì›ê¹Œì§€ì˜ ì¡°ì§ êµ¬ì¡° ê³„ì¸µ ê¹Šì´(depth)ë¥¼ êµ¬í•˜ê³ , ê²°ê³¼ë¥¼ depthê°€ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ëŠ” ì¿¼ë¦¬ë¥¼ ìž‘ì„±í•˜ì„¸ìš”.
> 

```sql
WITH RECURSIVE employee_hierarchy (id, name, manager_id, depth) AS (
  
  SELECT 
    id, 
    name, 
    manager_id, 
    0 AS depth
  FROM 
    Employees
  WHERE 
    manager_id IS NULL

  UNION ALL
  
  SELECT
    e.id, 
    e.name, 
    e.manager_id, 
    h.depth + 1 
  FROM 
    Employees e
  JOIN 
    employee_hierarchy h ON e.manager_id = h.id
)

SELECT 
  id, 
  name, 
  manager_id, 
  depth 
FROM 
  employee_hierarchy
ORDER BY 
  depth DESC
```

---

### ðŸŽ‰ ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.